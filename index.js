'use strict';var React=require('react');var _require=require('fs'),readdirSync=_require.readdirSync;var _require2=require('path'),resolve=_require2.resolve;var _require3=require(resolve(process.cwd(),'src/helpers.js')),isObject=_require3.isObject,isFunction=_require3.isFunction,isString=_require3.isString,isArray=_require3.isArray,arrayHasValues=_require3.arrayHasValues,resolveComponent=_require3.resolveComponent,renderComponent=_require3.renderComponent,avoidXSS=_require3.avoidXSS;var _require4=require('react-router-config'),renderRoutes=_require4.renderRoutes,matchRoutes=_require4.matchRoutes;module.exports=function(options){if(isObject(options)){// Prepare the middleware:
var middleware=function middleware(req,res,next){function prepareComponent(){if(routes){var props={title:'Untitled'};if(arguments[0]){if(isObject(arguments[0])){props=Object.assign(props,arguments[0])}}var component=matchRoutes(options.routes,req.url)[0].route.component.default;return{component:component,props:props}}else{if(arguments[0]){if(isString(arguments[0])){/* Require the component: */var _component=resolveComponent(resolve(componentsPath,arguments[0]));if(_component){var _props={title:'Untitled'};if(arguments.length===3&&isFunction(arguments[arguments.length-1])){if(arguments[1]){if(isObject(arguments[1])){_props=Object.assign(_props,arguments[1])}}}return{component:_component,props:_props}}else{throw new Error('"react-render-middleware" -> component was not found in the filesystem')}}else{throw new Error('"react-render-middleware" -> component argument must be a string type')}}else{throw new Error('"react-render-middleware" -> component argument must be defined')}}}function prepareContent(url,component,props,template,id){// -------------------------------------------------------- Content:
var content=renderComponent(url,component,props);var $=require('cheerio').load(template);$('title').text(props.title);$('head').append('<script id="__initial_state__">window.__INITIAL_STATE__ = '+avoidXSS(props)+'</script>');$('#'+id).html(content.html);// -------------------------------------------------------- Return:
return{html:$.html(),context:content.context,component:{original:component,rendered:content.html},props:{original:props,stringify:avoidXSS(props)},template:template,changes:{title:$('title').html(),state:$('#__initial_state__').html(),mount:$('#'+id).html()}}}function prepareResults(results,callback){if(isFunction(callback)){return callback(results)}else{return results}}// Description: Add a new function called "render" to the req object:
req.render=function render(){// ---------------------------------------------------------- Component & Props:
var _prepareComponent=prepareComponent.apply(undefined,arguments),component=_prepareComponent.component,props=_prepareComponent.props;// ---------------------------------------------------------- Content:
var results=prepareContent(req.url,component,props,templateHTML,mountId);// ---------------------------------------------------------- Return:
return prepareResults(results,arguments[arguments.length-1])};// Call next:
return next()};// Get variables from options (if they were passed...)
var templateHTML=options.templateHTML,mountId=options.mountId,componentsPath=options.componentsPath,routes=false;// Check if routes option is valid:
if('routes'in options){if(!isArray(options.routes)){throw new Error('"react-render-middleware" -> "routes" property must be an array.')}if(arrayHasValues(options.routes)){routes=true}}// This option is used independently if routes were found or not.
if(!templateHTML){throw'"react-render-middleware" -> "templateHTML" property must be defined'}else{if(!isString(templateHTML)){throw'"react-render-middleware" -> "templateHTML" must be a string path type'}}// This option is used independently if routes were found or not.
if(!mountId){throw'"react-render-middleware" -> "mountId" property must be defined'}else{if(!isString(mountId)){throw'"react-render-middleware" -> "mountId" must be a string path type'}else{if(!templateHTML.includes('id="'+mountId+'"')){throw'"react-render-middleware" -> "mountId" was not found in the template'}}}// Check if componentsPath option is valid (only if routes were not found):
if(!routes){// Prepare component in case routes weren't provided in options.
if(!componentsPath){throw'"react-render-middleware" -> "componentsPath" property must be defined'}else{if(!isString(componentsPath)){throw'"react-render-middleware" -> "componentsPath" must be a string path type'}else{try{readdirSync(componentsPath,{encoding:'UTF-8'})}catch(err){throw'\n"react-render-middleware" -> \nReason: Directory doesn\'t exists in the filesystem.\ncomponentsPath: "'+componentsPath+'"\nCode: "'+err.code+'"\n'}}}};// Return the middleware:
return middleware}else{throw'"react-render-middleware" -> Options object was not passed to the middleware.'}};

//# sourceMappingURL=data:application/json;charset=utf-8;base64,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ImNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKTtcbmNvbnN0IHsgcmVhZGRpclN5bmMgfSA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCB7IHJlc29sdmUgfSA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHtcbiAgaXNPYmplY3QsXG4gIGlzRnVuY3Rpb24sXG4gIGlzU3RyaW5nLFxuICBpc0FycmF5LFxuICBhcnJheUhhc1ZhbHVlcyxcbiAgcmVzb2x2ZUNvbXBvbmVudCxcbiAgcmVuZGVyQ29tcG9uZW50LFxuICBhdm9pZFhTUyxcbn0gPSByZXF1aXJlKHJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJ3NyYy9oZWxwZXJzLmpzJykpO1xuY29uc3QgeyByZW5kZXJSb3V0ZXMsIG1hdGNoUm91dGVzIH0gPSByZXF1aXJlKCdyZWFjdC1yb3V0ZXItY29uZmlnJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gKG9wdGlvbnMpID0+IHtcbiAgaWYgKGlzT2JqZWN0KG9wdGlvbnMpKSB7XG5cbiAgICAvLyBHZXQgdmFyaWFibGVzIGZyb20gb3B0aW9ucyAoaWYgdGhleSB3ZXJlIHBhc3NlZC4uLilcbiAgICBsZXQgeyB0ZW1wbGF0ZUhUTUwsIG1vdW50SWQsIGNvbXBvbmVudHNQYXRoIH0gPSBvcHRpb25zLCByb3V0ZXMgPSBmYWxzZTtcblxuICAgIC8vIENoZWNrIGlmIHJvdXRlcyBvcHRpb24gaXMgdmFsaWQ6XG4gICAgaWYgKCgncm91dGVzJyBpbiBvcHRpb25zKSkge1xuICAgICAgaWYgKCFpc0FycmF5KG9wdGlvbnMucm91dGVzKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcInJvdXRlc1wiIHByb3BlcnR5IG11c3QgYmUgYW4gYXJyYXkuJyk7XG4gICAgICB9XG4gICAgICBpZiAoYXJyYXlIYXNWYWx1ZXMob3B0aW9ucy5yb3V0ZXMpKSB7XG4gICAgICAgIHJvdXRlcyA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVGhpcyBvcHRpb24gaXMgdXNlZCBpbmRlcGVuZGVudGx5IGlmIHJvdXRlcyB3ZXJlIGZvdW5kIG9yIG5vdC5cbiAgICBpZiAoIXRlbXBsYXRlSFRNTCkge1xuICAgICAgdGhyb3cgJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcInRlbXBsYXRlSFRNTFwiIHByb3BlcnR5IG11c3QgYmUgZGVmaW5lZCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghaXNTdHJpbmcodGVtcGxhdGVIVE1MKSkge1xuICAgICAgICB0aHJvdyAnXCJyZWFjdC1yZW5kZXItbWlkZGxld2FyZVwiIC0+IFwidGVtcGxhdGVIVE1MXCIgbXVzdCBiZSBhIHN0cmluZyBwYXRoIHR5cGUnO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFRoaXMgb3B0aW9uIGlzIHVzZWQgaW5kZXBlbmRlbnRseSBpZiByb3V0ZXMgd2VyZSBmb3VuZCBvciBub3QuXG4gICAgaWYgKCFtb3VudElkKSB7XG4gICAgICB0aHJvdyAnXCJyZWFjdC1yZW5kZXItbWlkZGxld2FyZVwiIC0+IFwibW91bnRJZFwiIHByb3BlcnR5IG11c3QgYmUgZGVmaW5lZCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghaXNTdHJpbmcobW91bnRJZCkpIHtcbiAgICAgICAgdGhyb3cgJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcIm1vdW50SWRcIiBtdXN0IGJlIGEgc3RyaW5nIHBhdGggdHlwZSc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXRlbXBsYXRlSFRNTC5pbmNsdWRlcyhgaWQ9XCIke21vdW50SWR9XCJgKSkge1xuICAgICAgICAgIHRocm93ICdcInJlYWN0LXJlbmRlci1taWRkbGV3YXJlXCIgLT4gXCJtb3VudElkXCIgd2FzIG5vdCBmb3VuZCBpbiB0aGUgdGVtcGxhdGUnO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgY29tcG9uZW50c1BhdGggb3B0aW9uIGlzIHZhbGlkIChvbmx5IGlmIHJvdXRlcyB3ZXJlIG5vdCBmb3VuZCk6XG4gICAgaWYgKCFyb3V0ZXMpIHtcbiAgICAgIC8vIFByZXBhcmUgY29tcG9uZW50IGluIGNhc2Ugcm91dGVzIHdlcmVuJ3QgcHJvdmlkZWQgaW4gb3B0aW9ucy5cbiAgICAgIGlmICghY29tcG9uZW50c1BhdGgpIHtcbiAgICAgICAgdGhyb3cgJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcImNvbXBvbmVudHNQYXRoXCIgcHJvcGVydHkgbXVzdCBiZSBkZWZpbmVkJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghaXNTdHJpbmcoY29tcG9uZW50c1BhdGgpKSB7XG4gICAgICAgICAgdGhyb3cgJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcImNvbXBvbmVudHNQYXRoXCIgbXVzdCBiZSBhIHN0cmluZyBwYXRoIHR5cGUnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZWFkZGlyU3luYyhjb21wb25lbnRzUGF0aCwgeyBlbmNvZGluZzogJ1VURi04JyB9KTtcbiAgICAgICAgICB9IGNhdGNoKGVycikge1xuICAgICAgICAgICAgdGhyb3cgYFxcblwicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBcXG5SZWFzb246IERpcmVjdG9yeSBkb2Vzbid0IGV4aXN0cyBpbiB0aGUgZmlsZXN5c3RlbS5cXG5jb21wb25lbnRzUGF0aDogXCIke2NvbXBvbmVudHNQYXRofVwiXFxuQ29kZTogXCIke2Vyci5jb2RlfVwiXFxuYDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQcmVwYXJlIHRoZSBtaWRkbGV3YXJlOlxuICAgIGZ1bmN0aW9uIG1pZGRsZXdhcmUocmVxLCByZXMsIG5leHQpIHtcblxuICAgICAgZnVuY3Rpb24gcHJlcGFyZUNvbXBvbmVudCgpIHtcbiAgICAgICAgaWYgKHJvdXRlcykge1xuICAgICAgICAgIGxldCBwcm9wcyA9IHsgdGl0bGU6ICdVbnRpdGxlZCcgfTtcblxuICAgICAgICAgIGlmIChhcmd1bWVudHNbMF0pIHtcbiAgICAgICAgICAgIGlmIChpc09iamVjdChhcmd1bWVudHNbMF0pKSB7XG4gICAgICAgICAgICAgIHByb3BzID0gT2JqZWN0LmFzc2lnbihwcm9wcywgYXJndW1lbnRzWzBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQgY29tcG9uZW50ID0gbWF0Y2hSb3V0ZXMob3B0aW9ucy5yb3V0ZXMsIHJlcS51cmwpWzBdLnJvdXRlLmNvbXBvbmVudC5kZWZhdWx0O1xuXG4gICAgICAgICAgcmV0dXJuIHsgY29tcG9uZW50LCBwcm9wcyB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChhcmd1bWVudHNbMF0pIHtcbiAgICAgICAgICAgIGlmIChpc1N0cmluZyhhcmd1bWVudHNbMF0pKSB7XG4gICAgICAgICAgICAgIC8qIFJlcXVpcmUgdGhlIGNvbXBvbmVudDogKi9cbiAgICAgICAgICAgICAgbGV0IGNvbXBvbmVudCA9IHJlc29sdmVDb21wb25lbnQocmVzb2x2ZShjb21wb25lbnRzUGF0aCwgYXJndW1lbnRzWzBdKSk7XG5cbiAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudCkge1xuICAgICAgICAgICAgICAgIGxldCBwcm9wcyA9IHsgdGl0bGU6ICdVbnRpdGxlZCcgfTtcblxuICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIGlzRnVuY3Rpb24oYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGgtMV0pKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChhcmd1bWVudHNbMV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcHJvcHMgPSBPYmplY3QuYXNzaWduKHByb3BzLCBhcmd1bWVudHNbMV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29tcG9uZW50LCBwcm9wcyB9O1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignXCJyZWFjdC1yZW5kZXItbWlkZGxld2FyZVwiIC0+IGNvbXBvbmVudCB3YXMgbm90IGZvdW5kIGluIHRoZSBmaWxlc3lzdGVtJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignXCJyZWFjdC1yZW5kZXItbWlkZGxld2FyZVwiIC0+IGNvbXBvbmVudCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nIHR5cGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdcInJlYWN0LXJlbmRlci1taWRkbGV3YXJlXCIgLT4gY29tcG9uZW50IGFyZ3VtZW50IG11c3QgYmUgZGVmaW5lZCcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBmdW5jdGlvbiBwcmVwYXJlQ29udGVudCh1cmwsIGNvbXBvbmVudCwgcHJvcHMsIHRlbXBsYXRlLCBpZCkge1xuICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBDb250ZW50OlxuICAgICAgICBsZXQgY29udGVudCA9IHJlbmRlckNvbXBvbmVudCh1cmwsIGNvbXBvbmVudCwgcHJvcHMpO1xuICAgICAgICBsZXQgJCA9IHJlcXVpcmUoJ2NoZWVyaW8nKS5sb2FkKHRlbXBsYXRlKTtcbiAgICAgICAgJCgndGl0bGUnKS50ZXh0KHByb3BzLnRpdGxlKTtcbiAgICAgICAgJCgnaGVhZCcpLmFwcGVuZChgPHNjcmlwdCBpZD1cIl9faW5pdGlhbF9zdGF0ZV9fXCI+d2luZG93Ll9fSU5JVElBTF9TVEFURV9fID0gJHthdm9pZFhTUyhwcm9wcyl9PC9zY3JpcHQ+YCk7XG4gICAgICAgICQoYCMke2lkfWApLmh0bWwoY29udGVudC5odG1sKTtcblxuICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBSZXR1cm46XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaHRtbDogJC5odG1sKCksXG4gICAgICAgICAgY29udGV4dDogY29udGVudC5jb250ZXh0LFxuICAgICAgICAgIGNvbXBvbmVudDoge1xuICAgICAgICAgICAgb3JpZ2luYWw6IGNvbXBvbmVudCxcbiAgICAgICAgICAgIHJlbmRlcmVkOiBjb250ZW50Lmh0bWwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwcm9wczoge1xuICAgICAgICAgICAgb3JpZ2luYWw6IHByb3BzLFxuICAgICAgICAgICAgc3RyaW5naWZ5OiBhdm9pZFhTUyhwcm9wcylcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZSxcbiAgICAgICAgICBjaGFuZ2VzOiB7XG4gICAgICAgICAgICB0aXRsZTogJCgndGl0bGUnKS5odG1sKCksXG4gICAgICAgICAgICBzdGF0ZTogJCgnI19faW5pdGlhbF9zdGF0ZV9fJykuaHRtbCgpLFxuICAgICAgICAgICAgbW91bnQ6ICQoYCMke2lkfWApLmh0bWwoKVxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGZ1bmN0aW9uIHByZXBhcmVSZXN1bHRzKHJlc3VsdHMsIGNhbGxiYWNrKSB7XG4gICAgICAgIGlmIChpc0Z1bmN0aW9uKGNhbGxiYWNrKSkge1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhyZXN1bHRzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIERlc2NyaXB0aW9uOiBBZGQgYSBuZXcgZnVuY3Rpb24gY2FsbGVkIFwicmVuZGVyXCIgdG8gdGhlIHJlcSBvYmplY3Q6XG4gICAgICByZXEucmVuZGVyID0gZnVuY3Rpb24gcmVuZGVyKCkge1xuICAgICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIENvbXBvbmVudCAmIFByb3BzOlxuICAgICAgICBsZXQgeyBjb21wb25lbnQsIHByb3BzIH0gPSBwcmVwYXJlQ29tcG9uZW50KC4uLmFyZ3VtZW50cyk7XG5cbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBDb250ZW50OlxuICAgICAgICBsZXQgcmVzdWx0cyA9IHByZXBhcmVDb250ZW50KHJlcS51cmwsIGNvbXBvbmVudCwgcHJvcHMsIHRlbXBsYXRlSFRNTCwgbW91bnRJZCk7XG5cbiAgICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBSZXR1cm46XG4gICAgICAgIHJldHVybiBwcmVwYXJlUmVzdWx0cyhyZXN1bHRzLCBhcmd1bWVudHNbYXJndW1lbnRzLmxlbmd0aC0xXSk7XG4gICAgICB9O1xuXG4gICAgICAvLyBDYWxsIG5leHQ6XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH07XG5cbiAgICAvLyBSZXR1cm4gdGhlIG1pZGRsZXdhcmU6XG4gICAgcmV0dXJuIG1pZGRsZXdhcmU7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgJ1wicmVhY3QtcmVuZGVyLW1pZGRsZXdhcmVcIiAtPiBPcHRpb25zIG9iamVjdCB3YXMgbm90IHBhc3NlZCB0byB0aGUgbWlkZGxld2FyZS4nXG4gIH1cbn0iXX0=